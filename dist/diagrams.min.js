"use strict";function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _get=function(a,b,c){for(var d=!0;d;){var e=a,f=b,g=c;h=j=i=void 0,d=!1,null===e&&(e=Function.prototype);var h=Object.getOwnPropertyDescriptor(e,f);if(void 0!==h){if("value"in h)return h.value;var i=h.get;return void 0===i?void 0:i.call(g)}var j=Object.getPrototypeOf(e);if(null===j)return void 0;a=j,b=f,c=g,d=!0}},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(a){var b={},c=b;!function(){var a={},b=function(a){return"$"+a},d=function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"emit",value:function(a,c){var d=b(a);this._subjects[d]||(this._subjects[d]=new Rx.Subject),this._subjects[d].onNext(c)}},{key:"listen",value:function(a,c){var d=b(a);return this._subjects[d]||(this._subjects[d]=new Rx.Subject),this._subjects[d].subscribe(c)}},{key:"dispose",value:function(){var a=this._subjects;for(var b in a)({}).hasOwnProperty.call(a,b)&&a[b].dispose();this._subjects={}}}]),a}();c.Diagram=function(b){function d(b){_classCallCheck(this,d),_get(Object.getPrototypeOf(d.prototype),"constructor",this).call(this);var c=Object.getPrototypeOf(this);this._subjects={},this.name=b.name,this._configuration=this.configuration||{},_.merge(this._configuration,a),_.defaults(c,b.helpers),this.register(),this.setDiagramListeners()}return _inherits(d,b),_createClass(d,[{key:"handleItemClick",value:function(a,b){var c=this;a.on("click",function(){d3.event.stopPropagation(),c.emit("itemclick",b)})}},{key:"setDiagramListeners",value:function(){this.listen("itemclick",function(a){a&&a.text&&(c.tooltip("hide"),c.utils.fillBannerWithText(a.text))})}},{key:"config",value:function(a,b){var c,d=arguments.length,e=typeof a;if(1===d){if(_.isFunction(e))c=a();else if(_.isString(a))c=a;else if(_.isObject(a)){for(var f in a)this.config(f,a[f]);return a}return this._configuration[c]}return 2===d?(this._configuration[a]=b,b):void 0}},{key:"register",value:function(){var a=this;c[a.name]=function(){var b=arguments;c.utils.runIfReady(function(){a.create.apply(a,b)})},_.defaults(c[a.name],Object.getPrototypeOf(a))}}]),d}(d)}(),function(){c.shapes={},c.shapes.hexagon=function(a){var b,c,d,e=a.height/2,f=a.width/2,g=a.widthPercent?(1-a.widthPercent/100)*a.width:(a.width-a.height)/2,h="";return b=a.center||[f,e],c=b[0],d=b[1],h+="M"+(c-f)+","+d,h+="L"+(c-f+g)+","+(d+e),h+="L"+(c+f-g)+","+(d+e),h+="L"+(c+f)+","+d,h+="L"+(c+f-g)+","+(d-e),h+="L"+(c-f+g)+","+(d-e),h+="Z"}}(),function(){c.shared={get:function(a){if("set"===a||"get"===a)throw new Error("Reserved keyword: "+a);return c.shared[a]},set:function(a){var b=Object.keys(a);if(_.contains(b,"get")||_.contains(b,"set"))throw new Error("Reserved keyword in data: "+a);c.shared=_.defaults(c.shared,a)}}}(),function(){c.svg={},c.svg.addVerticalGradientFilter=function(a,b,c){var d=a.append("defs"),e=d.append("linearGradient").attr({id:b,x1:"0%",y1:"0%",x2:"0%",y2:"100%"});e.append("stop").attr("offset","0%").style({"stop-color":c[0],"stop-opacity":1}),e.append("stop").attr("offset","100%").style({"stop-color":c[1],"stop-opacity":1})},c.svg.addFilterColor=function(a,b,c,d,e){var f=b.append("defs"),g=f.append("filter").attr({id:"diagrams-drop-shadow-"+a});e&&g.attr({width:"500%",height:"500%",x:"-200%",y:"-200%"}),g.append("feOffset").attr({result:"offOut","in":"SourceGraphic",dx:.5,dy:.5}),g.append("feGaussianBlur").attr({result:"blurOut","in":"offOut",stdDeviation:c}),g.append("feBlend").attr({"in":"SourceGraphic",in2:"blurOut",mode:"normal"}),g.append("feComponentTransfer").append("feFuncA").attr({type:"linear",slope:d})},c.svg.generateSvg=function(a){var b=document.body.getBoundingClientRect();return d3.select("body").append("svg").attr({width:b.width-40,height:4e3}).style(a)},c.svg.updateHeigthOfElWithOtherEl=function(a,b,c){a.attr({height:b[0][0].getBoundingClientRect().height+(c||0)})},c.svg.textEllipsis=function(a){return function(){for(var b=d3.select(this),c=b.node().getComputedTextLength(),d=b.text();c>a&&d.length>0;)d=d.slice(0,-4),b.text(d+"..."),c=b.node().getComputedTextLength()}}}(),function(){c.tooltip=function(a,b,d){var e,f,g,h,i="diagrams-tooltip",j=d3.select("#"+i),k="",l=function(){var a=document.body,b=document.documentElement;return Math.max(a.scrollHeight,a.offsetHeight,b.clientHeight,b.scrollHeight,b.offsetHeight)}(),m=function(){d=c.utils.formatTextFragment(d)},n=function(){m(),j.html(d)};d!==!1&&(null===j[0][0]&&(g=d3.select("body"),j=g.insert("div","svg").attr({id:i})),"show"===a?(k+="display: inline-block; ",n(),b="string"==typeof b?document.getElementById(b):document.getElementById(b[0][0].id),h=b.getBoundingClientRect(),j.attr("style",k+"; opacity: 0"),e=j.node().getBoundingClientRect().height,f=h.top+h.height+document.body.scrollTop+20,f+e>l&&(f=h.top+document.body.scrollTop-20-e,0>f&&(f=h.top+h.height+document.body.scrollTop-e)),k+="top: "+f+"px; "):"hide"===a&&(k+="display: none; "),j.attr("style",k))},c.tooltip.onMouseEnterListenerFn=_.partial(c.tooltip,"show"),c.tooltip.onMouseLeaveListenerFn=_.partial(c.tooltip,"hide"),c.tooltip.setMouseListeners=function(a,b,d){a.on("mouseenter",function(){c.tooltip.onMouseEnterListenerFn(b,d)}),a.on("mouseleave",function(){c.tooltip.onMouseLeaveListenerFn()})},c.tooltip.generateATextDescriptionStr=function(a,b){return"<strong>"+a+"</strong>"+(b?"<br>"+b:"")}}(),function(){c.utils={},c.utils.d3DefaultReturnFn=function(a,b,c){return a=a.split("."),function(d){var e=_.reduce(a,function(a,b){return a[b]},d);return b||c?b+e+c:e}},c.utils.applySimpleTransform=function(a){a.attr("transform",function(a){return"translate("+a.x+","+a.y+")"})},c.utils.positionFn=function(a,b){return b=b||0,c.utils.d3DefaultReturnFn(a,0,b)},c.utils.textFn=function(a,b,d){return b=b||"",d=d||"",c.utils.d3DefaultReturnFn(a,b,d)},c.utils.runIfReady=function(a){"complete"===document.readyState?a():window.onload=a},c.utils.fillBannerWithText=function(a){var b,d,e="diagrams-banner",f=d3.select("#"+e),g=d3.select("body");f&&f.remove(),d='<div class="diagrams-banner-cross">&#x2715;</div>',d+=c.utils.formatTextFragment(a),b=g.insert("div","svg").attr({id:e}).html(d),b.on("click",function(){b.remove()})},c.utils.replaceCodeFragmentOfText=function(a,b){var c=/``([\s\S]*?)``([\s\S]*?)``/g,d=a.match(c);return a.replace(c,function(a,c,e){return b(a,c,e,d)})},c.utils.formatTextFragment=function(a){return a=c.utils.replaceCodeFragmentOfText(a,function(a,b,c,d){var e=a===_.last(d);return"<pre"+(e?' class="last-code-block" ':"")+"><code>"+hljs.highlight(b,c).value+"</pre></code>"})},c.utils.codeBlockOfLanguageFn=function(a,b){return b=b||"",function(c,d,e){return e===!0&&(c=b+" ...\n"+c+"\n"+b+" ..."),_.isString(d)&&(c=b+" @"+d+"\n"+c),"``"+a+"``"+c+"``"}},c.utils.wrapInParagraph=function(a){return"<p>"+a+"</p>"},c.utils.fillBannerOnClick=function(a,b,d){var e=d?"mousedown":"click";a.on(e,function(){c.tooltip("hide"),d3.event.stopPropagation(),c.utils.fillBannerWithText(b)})}}(),function(){var a,d={generateDefinitionWithSharedGet:function(){var b,d,e=arguments[0];return d=arguments.length>1?arguments[1]:"",b=d+e.split("(")[0],a.generateDefinition(e,c.shared.get(b))},addConvertToLayersButton:function(a){var c=d3.select("body");c.insert("div","svg").append("input").attr({type:"button","class":"conversion-button",value:"Convert to layers diagram",onclick:"diagrams.box.convertToLayerWrapper()"}),b.box.convertToLayerWrapper=function(){d.convertToLayer(a)}},convertToLayer:function(a){var b=function f(a){_.each(a,function(b,c){_.isString(b)&&(b=a[c]={text:b}),b.description&&(b.text+=": "+b.description),b.dependants?f(b.dependants):b.dependants=[]})},d=function(){var a=d3.select("svg"),b=d3.select("input");a.remove(),b.remove(),c.layer(e)},e=[];e.push({text:a.name,dependants:a.body}),b(e[0].dependants),d()},generateContainer:function(a,b,c){var d;return _.isArray(b)&&(c=b,b=null),d={type:"container",text:a,dependants:c,description:b}},generateLink:function(a,b){return{type:"link",text:a,url:b}},generateDefinition:function(a,b){return{type:"definition",text:a,description:b}}},e=0;new(a=function(a){function b(){_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).apply(this,arguments)}return _inherits(b,a),_createClass(b,[{key:"create",value:function(a){var b,f=this,g=_.cloneDeep(a),h=c.svg.generateSvg(),i=h.attr("width")-40,j=50,k=h.append("g").attr({transform:"translate(20, 20)","class":"box-diagram"}),l=k.append("g"),m=k.append("g").attr({transform:"translate(0, "+j+")"}),n=1,o=30,p=35,q=function r(b,d,g){var i,j,k,l,q,s;b=b||a.body,d=d||m,g=g||1,_.each(b,function(a){var b,m;b="diagrams-box-text-"+e++,"container"===a.type?(i=d.append("g"),s="Â· "+a.text,a.dependants&&a.dependants.length>0&&(s+=":"),a.description?(m=c.tooltip.generateATextDescriptionStr(s,a.description),s+=" (...)"):m=!1,k=i.append("text").text(s).attr({x:p*g,y:o*++n,id:b}),r(a.dependants,i,g+1)):"link"===a.type?(k=d.append("svg:a").attr("xlink:href",a.url).append("text").text(a.text).attr({id:b,x:p*g,y:o*++n,fill:"#3962B8"}),m=a.text+" ("+a.url+")"):"definition"===a.type?(k=d.append("g").attr({id:b}),j=k.append("text").text(a.text).attr({x:p*g,y:o*++n}).style({"font-weight":"bold"}),a.description&&(l=j[0][0].getBoundingClientRect().width,q=h[0][0].getBoundingClientRect().width-l-p*g-30,k.append("text").text("- "+a.description).attr({x:p*g+l+5,y:o*n-1}).each(c.svg.textEllipsis(q))),m=c.tooltip.generateATextDescriptionStr(a.text,a.description)):_.isString(a)&&(k=d.append("text").text(a).attr({id:b,x:p*g,y:o*++n}),m=a),f.handleItemClick(k,{text:m}),c.tooltip.setMouseListeners(k,b,m)})};c.svg.addFilterColor("box",h,3,4),l.append("rect").attr({height:j,width:i,stroke:"#000",fill:"#fff"}).style({filter:"url(#diagrams-drop-shadow-box)"}),l.append("text").attr({x:i/2,y:30}).text(a.name).style({"font-weight":"bold","text-anchor":"middle"}),b=m.append("rect").attr({width:i,stroke:"#000",fill:"#fff"}).style({filter:"url(#diagrams-drop-shadow-box)"}),q(),c.svg.updateHeigthOfElWithOtherEl(h,k,50),c.svg.updateHeigthOfElWithOtherEl(b,k,25-j),d.addConvertToLayersButton(g)}}]),b}(c.Diagram))({name:"box",helpers:d})}(),function(){var a,b,d=c.utils.positionFn,e=c.utils.textFn,b={generateNodeOptions:function(a){var c,d={};return _.isString(a)?b.generateNodeOptions(a.split(" ")):_.isArray(a)?(_.each(a,function(a){"s-"===a.substr(0,2)?(c=a.substr(2,a.length-2),"t"===c?d.shape="triangle":"s"===c?d.shape="square":d.shape="circle"):"b"===a&&(d.bold=!0)}),d):void 0},generateNode:function(){var a,c={name:arguments[0]};return a=_.isString(arguments[1])?arguments[1]:String(arguments[1]),a=a.split(" ").map(Number),a.length>0&&(c.id=a[0]),a.length>1&&(c.calledBy=[],_.each(a,function(a,b){b>0&&c.calledBy.push(a)})),arguments.length>2&&(c.description=arguments[2]),arguments.length>3&&(c.options=b.generateNodeOptions(arguments[3])),c},generateNodeWithSharedGet:function(){var a,d,e,f=arguments[0];return d=arguments.length>2?arguments[2]:"",a=d+f.split("(")[0],e=arguments.length>3?arguments[3]:null,b.generateNode(f,arguments[1],c.shared.get(a),e)},generateFnNodeWithSharedGetAndBoldIfFile:function(a){return function(){var c="",d="";return arguments[0].split("@")[0]===a&&(c="b"),arguments.length>2&&(d=arguments[2]),arguments.length>3&&(c=arguments[3]+" "+c),b.generateNodeWithSharedGet(arguments[0],arguments[1],d,c)}}};new(a=function(a){function b(){_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).apply(this,arguments)}return _inherits(b,a),_createClass(b,[{key:"create",value:function(a,b){var f,g,h,i,j,k,l,m,n,o,p=Math.max(document.documentElement.clientHeight,window.innerHeight||0),q=c.svg.generateSvg(),r=q.append("g"),s=p-250,t=q.attr("width"),u=function(){h.select("path.link-path").attr("d",function(a){var b=a.target.x-a.source.x,c=a.target.y-a.source.y,d=Math.sqrt(b*b+c*c);return"M"+a.source.x+","+a.source.y+"A"+d+","+d+" 0 0,1 "+a.target.x+","+a.target.y}),i.each(function(a){"circle"===a.shape?i.select("circle").attr("cx",d("x")).attr("cy",d("y")):("triangle"===a.shape?m=i.select("path.triangle"):"square"===a.shape&&(m=i.select("path.square")),c.utils.applySimpleTransform(m))}),i.select("text").attr("x",d("x")).attr("y",d("y",-20))},v=function(){var c,d,e,f,g=_.reduce(a,function(a,b){var c=b.id||0;return a>c?a:c},0),h={},i={},j=d3.scale.category10();o={links:[],nodes:[]},n=[],_.each(a,function(a,b){c=_.isUndefined(a.id)?g++:a.id,d=j(b),e=a.options||{},o.nodes.push({name:a.name,id:c,calledBy:a.calledBy||[],description:a.description||null,color:d,shape:e.shape||"circle",bold:e.bold||!1}),h[c]={index:b},_.isArray(a.calledBy)&&a.calledBy.length>0&&(h[c].color=d,n.push({id:c,color:d}))}),_.each(o.nodes,function(a,c){a.calledBy.length>0&&_.each(a.calledBy,function(d){f=h[d],f&&(b.hideNodesWithoutLinks&&(i[h[d].index]=!0,i[c]=!0),o.links.push({source:h[d].index,target:c,color:h[a.id].color,targetId:a.id}))})}),b.hideNodesWithoutLinks===!0&&_.each(o.nodes,function(a,b){i[b]!==!0&&(a.hidden=!0)})},w=function(){r.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")},x=function(){d3.event.sourceEvent.stopPropagation(),d3.select(this).classed("dragging",!0),f.start()},y=function(a){d3.select(this).attr("cx",a.x=d3.event.x).attr("cy",a.y=d3.event.y)},z=function(){d3.select(this).classed("dragging",!1)},A=function(){_.each(o.nodes,function(a){a.dependants=[],a.dependencies=[]}),_.each(o.links,function(a){a.source.dependencies.push(a.target),a.target.dependants.push(a.source)})};b=b||{},v(),q.attr({height:s,"class":"graph-diagram"}),j=d3.behavior.zoom().scaleExtent([.1,10]).on("zoom",w),q.call(j),f=d3.layout.force().size([t,s]).charge(b.charge||-1e4).linkDistance(b.linkDistance||140).on("tick",u),g=d3.behavior.drag().origin(function(a){return a}).on("dragstart",x).on("drag",y).on("dragend",z),f.nodes(o.nodes).links(o.links).start(),r.append("svg:defs").selectAll("marker").data(n).enter().append("svg:marker").attr({id:e("id","arrow-head-"),"class":"arrow-head",fill:e("color"),viewBox:"0 -5 10 10",refX:19,refY:-1.5,markerWidth:8,markerHeight:8,orient:"auto"}).append("svg:path").attr("d","M0,-5L10,0L0,5"),h=r.selectAll(".link").data(o.links).enter().append("g").attr("class","link"),h.append("svg:path").attr({"class":"link-path","marker-end":e("targetId","url(#arrow-head-",")")}).style("stroke",e("color")),i=r.selectAll(".node").data(o.nodes).enter().append("g").attr({"class":function(a){var b="node";return a.hidden===!0&&(b+=" node-hidden"),b},id:e("id","node-")}),i.each(function(a){var b=c.tooltip.generateATextDescriptionStr(a.name,a.description),d="";k=d3.select(this),"circle"===a.shape?m=k.append("circle").attr({r:12,fill:e("color")}):(l=d3.svg.symbol().size(750),m=k.append("path"),"triangle"===a.shape?(l=l.type("triangle-up"),d+=" triangle"):"square"===a.shape&&(l=l.type("square"),d+=" square"),m=m.attr({d:l,fill:e("color")}),c.utils.applySimpleTransform(m)),m.call(g),d+=a.bold===!0?" bold":" thin",m.attr("class",d),c.tooltip.setMouseListeners(m,"node-"+a.id,b)}),i.append("text").text(e("name")),A()}}]),b}(c.Diagram))({name:"graph",helpers:b})}(),function(){var a,d=0,e=c.utils.textFn,f={ids:0,Grid:function(){function a(b){_classCallCheck(this,a),this.position={x:0,y:0},this.width=b,this.cells=[]}return _createClass(a,[{key:"addDependantAtNewRow",value:function(a){var b=0;for(this.position.x=0;1e3>b&&(this.position.y+=1,!this.dependantFitsAtCurrentPos(a)););this.addDependantAtCurrentPos(a)}},{key:"addDependantAtCurrentPos",value:function(a){this.addDependantAtPos(a,this.position)}},{key:"createRowIfNecessary",value:function(a){_.isUndefined(this.cells[a])&&(this.cells[a]=[])}},{key:"addDependantAtPos",value:function(a,b){var c;a.x=b.x,a.y=b.y;for(var d=0;d<a.height;d++){this.createRowIfNecessary(d+b.y),c=this.cells[d+b.y];for(var e=0;e<a.width;e++)c[e+b.x]=!0}this.updatePosition()}},{key:"updatePosition",value:function(){for(var a=0;1e3>a;){if(this.position.x+=1,this.position.x===this.width)this.position.x=-1,this.position.y+=1,this.createRowIfNecessary(this.position.y);else if(this.cells[this.position.y][this.position.x]!==!0)break;a++}}},{key:"dependantFitsAtPos",value:function(a,b){for(var c,d=0;d<a.height;d++){if(c=this.cells[d+b.y],_.isUndefined(c))return!0;for(var e=0;e<a.width;e++){if(c[e+b.x]===!0)return!1;if(e+b.x+1>this.width)return!1}}return!0}},{key:"dependantFitsAtCurrentPos",value:function(a){return this.dependantFitsAtPos(a,this.position)}},{key:"movePositionToNextRow",value:function(){this.position.y++,this.position.x=0,this.createRowIfNecessary(this.position.y)}},{key:"lastRowIsEmpty",value:function(){for(var a=this.cells.length,b=0;b<this.width;b++)if(this.cells[a-1][b]===!0)return!1;return!0}},{key:"getSize",value:function(){var a=this.cells.length;return{width:this.width,height:this.lastRowIsEmpty()?a-1:a}}}]),a}(),config:{widthSize:350,heightSize:60,depthWidthFactor:4,depthHeightFactor:2,showNumbersAll:!1},handleConnectedToNextCaseIfNecessary:function(a,b){var c,d,e=a[b],g=a[b+1];e.hasOwnProperty("connectedWithNext")===!0&&g&&(g.id?d=g.id:(d="to-next-"+String(++f.ids),g.id=d),c=_.isObject(e.connectedWithNext)&&e.connectedWithNext.type?{id:d,type:e.connectedWithNext.type}:d,e.connectedTo?e.connectedTo.push(c):e.connectedTo=[c])},dependantsOfLayerShouldBeSorted:function(a){var b=!0;return _.each(a,function(a){a.hasOwnProperty("connectedTo")&&(b=!1),a.hasOwnProperty("connectToNext")&&(b=!1)}),b},calculateLayerWithChildrenDimensions:function(a){var b,c,d,e,g,h,i=0,j=0,k=0,l=0,m=[],n=0,o=function(a){return b[a].inNewRow===!0?(c.addDependantAtNewRow(b[a]),b.splice(a,1),!0):c.dependantFitsAtCurrentPos(b[a])?(c.addDependantAtCurrentPos(b[a]),b.splice(a,1),!0):!1};for(_.each(a.dependants,function(a){i+=a.width,j+=a.height,l=a.height>l?a.height:l,k=a.width>k?a.width:k,m.push(a)}),e=i/2>=k?j>i?j/2<a.dependants.length?Math.ceil(i/2):i:Math.ceil(i/2):k,e=f.maxUnityWidth<e?f.maxUnityWidth:e,c=new f.Grid(e),h=f.dependantsOfLayerShouldBeSorted(m),b=h?m.sort(function(a,b){return a.width===b.width?a.height<b.height:a.width<b.width}):m,o(0),d=0;b.length>0&&1e3>n;)o(d)?d=0:h?(d++,d===b.length&&(d=0,c.movePositionToNextRow())):c.movePositionToNextRow(),n++;g=c.getSize(),a.x=0,a.y=0,a.width=g.width,a.height=a.dependants.length>0?g.height+1:g.height},generateLayersData:function(a,b){var c,d,e=f.config;return b=b||1,c=b,_.each(a,function(g,h){g.showNumbersAll===!0&&(e.showNumbersAll=!0),g.depth=b,f.handleConnectedToNextCaseIfNecessary(a,h),g.dependants.length>0?(d=f.generateLayersData(g.dependants,b+1),g.maxLayerDepthBelow=d-b,f.calculateLayerWithChildrenDimensions(g),c=d>c?d:c):(g.maxLayerDepthBelow=0,g.width=1,g.height=1,c=d>c?d:c),g.alreadyConnections=[]}),c},getFinalLayerDimensions:function(a){var b=f.config,c=a.height*b.heightSize-b.depthHeightFactor*a.depth*2,d=a.width*b.widthSize-b.depthWidthFactor*a.depth*2,e="translate("+b.depthWidthFactor*a.depth+","+b.depthHeightFactor*a.depth+")",g="url(#color-"+String(a.depth-1)+")",h={height:c,width:d,transform:e,fill:g};return(b.showNumbersAll===!0||a.containerData&&a.containerData.showNumbers===!0)&&(h.numberTransform="translate("+String(d-15+b.depthWidthFactor*a.depth)+","+String(b.depthHeightFactor*a.depth+c+0)+")"),h},addConvertToBoxButton:function(a){var c=d3.select("body");c.insert("div","svg").append("input").attr({type:"button","class":"conversion-button",value:"Convert to box diagram",onclick:"diagrams.layer.convertToBoxWrapper()"}),b.layer.convertToBoxWrapper=function(){f.convertToBox(a)}},convertToBox:function(a){var b,d=function f(a){var b;_.each(a,function(c,d){b=c.text.split(": "),c.text=b[0],b.length>1&&(c.description=b[1]),c.dependants&&c.dependants.length>0?(c.type="container",f(c.dependants)):_.isString(c.description)===!1?a[d]=c.text:(c.type="definition",c.dependants=null)})},e=function(){var a=d3.select("svg"),d=d3.select("input");a.remove(),d.remove(),c.box(b)};_.isArray(a)&&(a=a[0]),b={name:a.text,body:a.dependants},d(b.body),e()},newLayer:function(a,b,c){var d={text:a};return _.isArray(b)?c=b:(_.isString(b)&&(b=f.extendOpts(b)),_.isObject(b)&&(d=_.extend(d,b))),c&&(d.dependants=c),_.isUndefined(d.id)&&(d.id="layer-"+ ++f.ids+"-auto"),d},newLayerConnectedToNext:function(){var a=arguments.length;return 1===a?f.newLayer(arguments[0],"cn"):2===a?"object"==typeof arguments[1]?f.newLayer(arguments[0],"cn",arguments[1]):f.newLayer(arguments[0],arguments[1]+" cn"):3===a?f.newLayer(arguments[0],arguments[1]+" cn",arguments[2]):void 0},staticOptsLetters:{co:{conditional:!0},cn:{connectedWithNext:!0},sna:{showNumbersAll:!0},sn:{showNumbers:!0},cnd:{connectedWithNext:{type:"dashed"}},nr:{inNewRow:!0}},idOpt:function(a){return{id:"layer-"+a+"-custom"}},extendOpts:function(){var a={};return _.each(arguments,function(b){"string"==typeof b?_.each(b.split(" "),function(b){"id-"===b.substr(0,3)?a=_.extend(a,f.idOpt(b.substr(3,b.length))):"ct-"===b.substr(0,3)?f.connectWithOpt(Number(b.substr(3,b.length)),a):"ctd-"===b.substr(0,4)?f.connectWithOpt(Number(b.substr(4,b.length)),a,"dashed"):a=_.extend(a,f.staticOptsLetters[b])}):_.isObject(b)&&(a=_.extend(a,b))}),a},connectWithOpt:function(a,b,c){var d=[];_.isNumber(a)&&(a=[a]),c=c||"standard",_.each(a,function(a){d.push({id:"layer-"+a+"-custom",type:c})}),_.isUndefined(b.connectedTo)===!0?b.connectedTo=d:b.connectedTo=b.connectedTo.concat(d)},connectWithOptAndIdOpt:function(a,c){var d=b.layer.connectWithOpt(a),e=b.layer.idOpt(c);return _.extend(d,e)}};_.each(["newLayer","newLayerConnectedToNext"],function(a){f[a+"WithCode"]=function(c){var d=b.utils.codeBlockOfLanguageFn(c);return function(){var b=arguments;return b[0]=d(b[0]),f[a].apply(this,b)}},f[a+"WithParagraphAndCode"]=function(d){var e=b.utils.codeBlockOfLanguageFn(d);return function(){var b=[].splice.call(arguments,0),d=b[0],g=b[1],h=c.utils.wrapInParagraph(d)+e(g);return b=b.splice(2),b.unshift(h),f[a].apply(this,b)}}}),new(a=function(a){function b(){_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).apply(this,arguments)}return _inherits(b,a),_createClass(b,[{key:"create",value:function(a){var b=this,g=_.cloneDeep(a),h=f.config,i=["#ECD078","#D95B43","#C02942","#78E4B7","#53777A","#00A8C6","#AEE239","#FAAE8A"],j=function u(a){_.each(a,function(a){a.hasOwnProperty("dependants")===!1?a.dependants=[]:u(a.dependants)})},k=function(a,b){var c,d=function(a){return{x:(a.x+a.width/2)*h.widthSize+h.depthWidthFactor*a.depth,y:a.y*h.heightSize+h.depthHeightFactor*a.depth}},e=function(a){return{x:(a.x+a.width/2)*h.widthSize+h.depthWidthFactor*a.depth,y:(a.y+a.height)*h.heightSize-h.depthHeightFactor*a.depth}},f=function(a){return{x:a.x*h.widthSize+h.depthWidthFactor*a.depth,y:(a.y+a.height/2)*h.heightSize+h.depthHeightFactor*a.depth}},g=function(a){return{x:(a.x+a.width)*h.widthSize-h.depthWidthFactor*a.depth,y:(a.y+a.height/2)*h.heightSize+h.depthHeightFactor*a.depth}},i=function(a){return{top:d(a),bottom:e(a),left:f(a),right:g(a)}},j={val:1/0},k=function(a,b,c,d){if("bottom"!==c&&"left"!==c&&"top"!==c||"right"!==d){if("bottom"!==c&&"right"!==c&&"top"!==c||"left"!==d){if("bottom"!==c&&"right"!==c&&"left"!==c||"top"!==d){if(("left"===c||"right"===c||"top"===c)&&"bottom"===d&&a.y<b.y)return!1}else if(a.y>b.y)return!1}else if(a.x>b.x)return!1}else if(a.x<b.x)return!1;return!0},l=function(a,b){var c=function(a){return Math.pow(a,2)},d=Math.sqrt(c(a.x-b.x)+c(a.y-b.y));return d<j.val?(j.val=d,j.from=a,j.to=b,!0):!1},m=function(a){_.each(["top","bottom","left","right"],function(b){a(b)})},n=function(a,b){var c=!1;return _.each([[a,b],[b,a]],function(a){"top"===a[0]&&"bottom"===a[1]?c=!0:"left"===a[0]&&"right"===a[1]&&(c=!0)}),c},o=function(b){m(function(d){m(function(e){_.isUndefined(p.alreadyConnections)&&(p.alreadyConnections=[]),d!==e&&a.alreadyConnections.indexOf(d)<0&&p.alreadyConnections.indexOf(e)<0&&(b===!1&&n(d,e)===!1||n(d,e))&&k(q[d],r[e],d,e)&&(c=l(q[d],r[e]),c===!0&&(j.sideA=d,j.sideB=e))})})},p=b.layer,q=i(a),r=i(p);return o(!0),c!==!0&&o(!1),a.alreadyConnections.push(j.sideA),p.alreadyConnections.push(j.sideB),j},l=function(a){var b,c,d,f,g,h=a.layer.container,j=a.layer.containerData;_.each(a.connectedTo,function(l){d=k(a.layer,l),f=d3.svg.line().x(e("x")).y(e("y")),c=a.layer.id+"-"+l.layer.id,b=h.append("g").attr("id",c),d.from&&d.to&&(g=b.append("path").attr("d",f([d.from,d.to])).style({stroke:"#000",fill:"none"}),"dashed"===l.type&&g.style("stroke-dasharray","5, 5"),b.append("circle").attr({cx:d.to.x,cy:d.to.y,r:5,fill:i[a.layer.depth-1]}).style({stroke:"#000"}),j.connections=j.connections||[],j.connections.push({el:b,id:c}))})},m=function v(b){b=b||a,_.chain(b).filter(function(a){return a.hasOwnProperty("connectedTo")}).map(function(a){var c,d,e,f=[];return _.each(a.connectedTo,function(a){d=_.isObject(a)?a.id:a,e=_.isObject(a)&&a.type?a.type:"standard",c=_.where(b,{id:d})[0],f.push({layer:c,type:e})}),{layer:a,connectedTo:f}}).each(function(a){l(a)}).value(),_.chain(b).filter(function(a){return a.dependants.length>0}).each(function(a){v(a.dependants)}).value()},n=function(){var b=function(a){return a.y+a.height},c=_.max(a,b),d=b(c),e=d*h.heightSize+20;t.attr("height",e)},o=function(){var a=document.body.getBoundingClientRect().width;f.maxUnityWidth=Math.floor(a/h.widthSize)},p=function(a){if(a.containerData){var b=a.containerData.connections;b&&_.each(b,function(a){a.el.style("opacity",1)})}},q=function(a){if(a.containerData){var b=a.containerData.connections;b&&_.each(b,function(b){-1===b.id.indexOf(a.id)&&b.el.style("opacity",.2)})}},r=function(a){return a=a.replace(/<p>/g,""),a=a.replace(/<\/p>/g,". "),a=c.utils.replaceCodeFragmentOfText(a,function(b,c,d){return b===a&&/\n/.test(b)===!1?d:"<CODE...>"})},s=function w(e,g,j){var k,l,m,n,o,s=h.widthSize,u=h.heightSize;e=e||a,g=g||t,_.each(e,function(a,e){o=function(b){b.on("mouseenter",function(){c.tooltip.onMouseEnterListenerFn(v,a.text),q(a)}),b.on("mouseleave",function(){c.tooltip.onMouseLeaveListenerFn(),p(a)})};var t,v="diagrams-layer-g-"+d++;k=g.append("g").attr({transform:"translate("+String(a.x*s)+", "+a.y*u+")","class":"layer-node",id:v}),a.layerG=k,a.container=g,a.containerData=j,m=f.getFinalLayerDimensions(a),l=k.append("g"),a.conditional===!0?l.append("path").attr({d:c.shapes.hexagon({height:m.height,width:m.width,widthPercent:97+Math.abs(3-a.depth)}),transform:m.transform,fill:m.fill,stroke:"#f00"}):l.append("rect").attr({width:m.width,transform:m.transform,height:m.height,fill:m.fill}).style({filter:"url(#diagrams-drop-shadow-layer)"}),n=l.append("text").attr({transform:m.transform,x:a.depth,y:a.height*u-3*a.depth-10}).text(function(){return r(a.text)}),o(n),o(l),n.each(c.svg.textEllipsis(a.width*s-h.depthWidthFactor*a.depth*2)),b.handleItemClick(k,{text:a.text}),m.numberTransform&&(t=l.append("g").attr({"class":"number",transform:m.numberTransform}),t.append("circle").attr({r:10,cx:4,cy:-4,fill:i[a.depth-1],"stroke-width":2,stroke:"#000",filert:"none"}),t.append("text").text(e+1).attr("fill","#000")),a.dependants.length>0&&w(a.dependants,k,a)})},t=c.svg.generateSvg({margin:"20px 0 0 20px"});_.each(i,function(a,b){c.svg.addVerticalGradientFilter(t,"color-"+b,["#fff",a])}),t.attr("class","layers-diagram"),_.isArray(a)===!1&&(a=[a]),c.svg.addFilterColor("layer",t,3,2),j(a),o(),f.generateLayersData(a),s(),m(),n(),f.addConvertToBoxButton(g)}}]),b}(c.Diagram))({name:"layer",helpers:f})}(),a.diagrams=b}(window);